name: Template for build and push a container image
on:
  workflow_call:
    inputs:
      RUNNER_LABELS:
        description: "Labels for the runner. Example: 'self-hosted', 'ubuntu', 'gpu', etc."
        required: true
        type: string
    secrets:
      CONTAINER_REGISTRY_URL:
        description: "Base container registry URL (e.g. ghcr.io/username, harbor.company.com/project, docker.io/username, your.private.container.registry/project, etc)"
        required: true
      CONTAINER_REGISTRY_USERNAME:
        description: "Username for the container registry"
        required: true
      CONTAINER_REGISTRY_PASSWORD:
        description: "Password for the container registry"
        required: true
    outputs:
      tags:
        description: "Container image tags generated by the build"
        value: ${{ jobs.build-push-image.outputs.tags }}
      labels:
        description: "Container image labels generated by the build"
        value: ${{ jobs.build-push-image.outputs.labels }}
      digests:
        description: "Container image digests generated by the build"
        value: ${{ jobs.build-push-image.outputs.digests }}
       
      
jobs:
  build-push-image:
    name: Build a container image
    runs-on: ${{ fromJson(format('[{0}]', inputs.RUNNER_LABELS)) }}
    outputs:
      tags: ${{ steps.metadata.outputs.tags }}
      labels: ${{ steps.metadata.outputs.labels }}
      digests: ${{ steps.metadata.outputs.digests }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.CONTAINER_REGISTRY_URL }}
          username: ${{ secrets.CONTAINER_REGISTRY_USERNAME }}
          password: ${{ secrets.CONTAINER_REGISTRY_PASSWORD }}

      - name: Extract timestamp
        id: timestamp
        run: echo "TIMESTAMP=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

      - name: Prepare Tags Metadata
        id: metadata
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.CONTAINER_REGISTRY_URL }}
          tags: |
            type=ref,event=branch,suffix=-latest
            type=ref,event=branch,suffix=-${{ steps.timestamp.outputs.TIMESTAMP }}
            type=semver,pattern={{version}}
            type=sha

      - name: Build and Push Container Image
        if: success()
        uses: docker/build-push-action@v3
        with:
          push: true
          labels: ${{ steps.metadata.outputs.labels }}
          tags: ${{ steps.metadata.outputs.tags }}